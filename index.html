<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Analyst</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:    #0d1f3c;
  --blue:    #1a56db;
  --blue-lt: #e8effd;
  --teal:    #0ea5a0;
  --teal-lt: #e6f7f7;
  --gray-50: #f8f9fb;
  --gray-100:#f0f2f5;
  --gray-200:#e2e6ed;
  --gray-400:#9aa3b0;
  --gray-600:#5a6474;
  --gray-800:#1e2a3a;
  --white:   #ffffff;
  --red:     #e53e3e;
  --green:   #22c55e;
  --shadow-sm: 0 1px 3px rgba(13,31,60,0.08), 0 1px 2px rgba(13,31,60,0.05);
  --shadow:    0 4px 16px rgba(13,31,60,0.10), 0 1px 4px rgba(13,31,60,0.06);
  --shadow-lg: 0 12px 40px rgba(13,31,60,0.13), 0 3px 8px rgba(13,31,60,0.07);
  --radius: 12px;
  --font: 'Manrope', sans-serif;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font);
  background: var(--gray-50);
  color: var(--gray-800);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  background: var(--white);
  border-bottom: 1px solid var(--gray-200);
  padding: 0 40px;
  height: 64px;
  display: flex;
  align-items: center;
  gap: 0;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
}

.logo-icon {
  width: 34px;
  height: 34px;
  background: var(--navy);
  border-radius: 8px;
  display: grid;
  place-items: center;
  font-size: 14px;
  font-weight: 800;
  color: white;
  letter-spacing: -0.5px;
  flex-shrink: 0;
}

.logo-text {
  font-size: 17px;
  font-weight: 800;
  color: var(--navy);
  letter-spacing: -0.3px;
}

.header-badge {
  margin-left: 10px;
  background: var(--teal-lt);
  color: var(--teal);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 3px 8px;
  border-radius: 20px;
  border: 1px solid rgba(14,165,160,0.2);
}

.header-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px;
  color: var(--gray-600);
  font-weight: 500;
}

.dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--gray-400);
  transition: background 0.2s;
  flex-shrink: 0;
}
.dot.ready  { background: var(--green); }
.dot.busy   { background: #f59e0b; animation: blink 0.9s infinite; }
.dot.error  { background: var(--red); }

@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main {
  max-width: 860px;
  margin: 0 auto;
  padding: 40px 24px 80px;
  width: 100%;
}

/* â”€â”€ HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hero {
  text-align: center;
  margin-bottom: 40px;
}
.hero h1 {
  font-size: 32px;
  font-weight: 800;
  color: var(--navy);
  letter-spacing: -0.5px;
  line-height: 1.2;
}
.hero h1 span { color: var(--blue); }
.hero p {
  margin-top: 10px;
  color: var(--gray-600);
  font-size: 15px;
  font-weight: 500;
  line-height: 1.6;
}

/* â”€â”€ STEP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.steps {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.card {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: box-shadow 0.2s;
}
.card:focus-within { box-shadow: var(--shadow); }

.card-header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 24px;
  border-bottom: 1px solid var(--gray-100);
  cursor: pointer;
  user-select: none;
}

.step-num {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--navy);
  color: white;
  font-size: 12px;
  font-weight: 800;
  display: grid;
  place-items: center;
  flex-shrink: 0;
}

.card-header h2 {
  font-size: 15px;
  font-weight: 700;
  color: var(--navy);
  flex: 1;
}

.card-header .subtitle {
  font-size: 12px;
  color: var(--gray-400);
  font-weight: 500;
}

.card-body {
  padding: 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field { display: flex; flex-direction: column; gap: 6px; }

.field label {
  font-size: 12px;
  font-weight: 700;
  color: var(--gray-600);
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

select, input[type="text"], input[type="password"], textarea {
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-800);
  background: var(--gray-50);
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  padding: 10px 14px;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  width: 100%;
  -webkit-appearance: none;
  appearance: none;
}
select:hover, input:hover, textarea:hover { border-color: var(--gray-400); }
select:focus, input:focus, textarea:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(26,86,219,0.1);
  background: var(--white);
}
select {
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='9' viewBox='0 0 14 9'%3E%3Cpath d='M1 1l6 6 6-6' stroke='%239aa3b0' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}
textarea { resize: vertical; line-height: 1.65; min-height: 100px; }

/* Key input with toggle */
.key-row { position: relative; }
.key-row input { padding-right: 80px; }
.key-actions {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 4px;
}
.icon-btn {
  background: var(--gray-100);
  border: none;
  border-radius: 6px;
  color: var(--gray-600);
  cursor: pointer;
  font-size: 13px;
  padding: 4px 7px;
  transition: background 0.15s, color 0.15s;
  line-height: 1;
}
.icon-btn:hover { background: var(--blue-lt); color: var(--blue); }

/* hint text */
.hint {
  font-size: 12px;
  color: var(--gray-400);
  font-weight: 500;
  line-height: 1.5;
}
.hint a { color: var(--blue); text-decoration: none; }
.hint a:hover { text-decoration: underline; }

/* provider badges */
.provider-note {
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  padding: 8px 12px;
  line-height: 1.5;
  display: none;
}
.provider-note.ok  { background: var(--teal-lt); color: #0a7570; border: 1px solid rgba(14,165,160,0.2); display:block; }
.provider-note.warn{ background: #fff7ed; color: #92400e; border: 1px solid #fed7aa; display:block; }

/* model row */
.model-row { display: flex; gap: 8px; align-items: flex-start; }
.model-row select { flex: 1; }
.fetch-btn {
  background: var(--gray-100);
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  color: var(--gray-600);
  cursor: pointer;
  font-family: var(--font);
  font-size: 12px;
  font-weight: 600;
  padding: 10px 12px;
  white-space: nowrap;
  transition: all 0.15s;
  flex-shrink: 0;
}
.fetch-btn:hover { background: var(--blue-lt); border-color: var(--blue); color: var(--blue); }

/* save key checkbox */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--gray-600);
  font-weight: 500;
  cursor: pointer;
}
.checkbox-row input[type="checkbox"] {
  width: 15px;
  height: 15px;
  accent-color: var(--blue);
  cursor: pointer;
  flex-shrink: 0;
  padding: 0;
  border-radius: 4px;
}

/* â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.run-card {
  background: var(--navy);
  border: none;
  border-radius: var(--radius);
  padding: 6px 6px 6px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

.run-card-text {
  color: rgba(255,255,255,0.7);
  font-size: 13px;
  font-weight: 500;
}

.run-btn {
  background: var(--blue);
  color: white;
  border: none;
  border-radius: 8px;
  font-family: var(--font);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.02em;
  padding: 13px 32px;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.run-btn:hover { background: #1648c0; }
.run-btn:active { transform: scale(0.97); }
.run-btn:disabled { background: var(--gray-400); cursor: not-allowed; transform: none; }

.run-btn svg { width: 16px; height: 16px; }

/* â”€â”€ OUTPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.output-card {
  background: var(--white);
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  display: none;
}
.output-card.visible { display: block; }

.output-toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 20px;
  border-bottom: 1px solid var(--gray-100);
  background: var(--gray-50);
}

.output-toolbar .label {
  font-size: 12px;
  font-weight: 700;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  flex: 1;
}

.output-toolbar .model-tag {
  background: var(--blue-lt);
  color: var(--blue);
  font-size: 11px;
  font-weight: 600;
  padding: 3px 9px;
  border-radius: 20px;
}

.small-btn {
  background: none;
  border: 1.5px solid var(--gray-200);
  border-radius: 6px;
  color: var(--gray-600);
  cursor: pointer;
  font-family: var(--font);
  font-size: 11px;
  font-weight: 600;
  padding: 5px 10px;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  transition: all 0.15s;
}
.small-btn:hover { border-color: var(--blue); color: var(--blue); }

.output-body {
  padding: 28px 28px;
  min-height: 120px;
}

/* loading skeleton */
.skeleton { display: none; }
.skeleton.visible { display: block; }
.skel-line {
  height: 14px;
  background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
  background-size: 200% 100%;
  border-radius: 4px;
  margin-bottom: 10px;
  animation: shimmer 1.3s infinite;
}
.skel-line:nth-child(2) { width: 85%; }
.skel-line:nth-child(3) { width: 92%; }
.skel-line:nth-child(4) { width: 60%; margin-bottom: 20px; }
.skel-line.h { height: 20px; width: 40%; margin-bottom: 14px; }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* rendered HTML output */
#output-content h1, #output-content h2, #output-content h3 {
  color: var(--navy);
  font-weight: 800;
  margin: 20px 0 8px;
  line-height: 1.3;
}
#output-content h1 { font-size: 20px; }
#output-content h2 { font-size: 17px; }
#output-content h3 { font-size: 15px; }
#output-content h1:first-child,
#output-content h2:first-child { margin-top: 0; }
#output-content p { font-size: 14px; line-height: 1.75; color: var(--gray-800); margin: 8px 0; }
#output-content ul, #output-content ol { padding-left: 20px; margin: 8px 0 12px; }
#output-content li { font-size: 14px; line-height: 1.7; margin: 4px 0; }
#output-content strong { color: var(--navy); font-weight: 700; }
#output-content a { color: var(--blue); }
#output-content code {
  background: var(--gray-100);
  color: var(--blue);
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 4px;
}
#output-content pre {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-left: 3px solid var(--blue);
  border-radius: 6px;
  padding: 14px;
  overflow-x: auto;
  margin: 12px 0;
}
#output-content blockquote {
  border-left: 3px solid var(--blue);
  padding-left: 14px;
  color: var(--gray-600);
  font-style: italic;
  margin: 12px 0;
}
#output-content table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin: 14px 0;
}
#output-content th {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  padding: 8px 12px;
  text-align: left;
  font-weight: 700;
  color: var(--navy);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
#output-content td {
  border: 1px solid var(--gray-200);
  padding: 8px 12px;
}
#output-content hr { border: none; border-top: 1px solid var(--gray-200); margin: 18px 0; }

/* error state */
.error-box {
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  padding: 14px 16px;
  color: var(--red);
  font-size: 13px;
  font-weight: 500;
  display: none;
}
.error-box.visible { display: block; }

/* â”€â”€ FILE WARNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-warn {
  background: #fffbeb;
  border-bottom: 2px solid #f59e0b;
  padding: 11px 40px;
  font-size: 13px;
  color: #78350f;
  font-weight: 500;
  display: none;
  line-height: 1.6;
}
.file-warn code {
  background: #fef3c7;
  padding: 1px 6px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 12px;
}
.file-warn a { color: #92400e; font-weight: 700; }

/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer {
  margin-top: auto;
  border-top: 1px solid var(--gray-200);
  padding: 16px 40px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--gray-400);
  font-weight: 500;
  background: var(--white);
}
footer span { color: var(--gray-600); font-weight: 600; }
footer .sep { color: var(--gray-200); }

@media (max-width: 600px) {
  header { padding: 0 16px; }
  main { padding: 24px 16px 60px; }
  .hero h1 { font-size: 24px; }
  .field-row { grid-template-columns: 1fr; }
  .run-card { flex-direction: column; align-items: stretch; text-align: center; padding: 16px; }
  .run-btn { justify-content: center; }
}
</style>
</head>
<body>

<div class="file-warn" id="file-warn">
  âš  <strong>Running from a local file</strong> â€” browsers block API calls this way. Quickest fix: open a terminal in this folder and run <code>python -m http.server 8080</code>, then visit <a href="http://localhost:8080" target="_blank">localhost:8080</a>. For permanent sharing, use <a href="https://pages.github.com" target="_blank">GitHub Pages</a>.
</div>

<header>
  <div class="header-logo">
    <div class="logo-icon">AI</div>
    <span class="logo-text" id="header-title">AI Analyst</span>
    <span class="header-badge" id="header-badge">Powered by AI</span>
  </div>
  <div class="header-right">
    <div class="status-pill">
      <div class="dot" id="status-dot"></div>
      <span id="status-text">Ready</span>
    </div>
  </div>
</header>

<main>

  <div class="hero">
    <h1 id="page-title">Your <span>AI-Powered</span> Analyst</h1>
    <p id="page-subtitle">Enter your input below, choose your AI provider, and get an instant structured analysis.</p>
  </div>

  <div class="steps">

    <div class="card">
      <div class="card-header">
        <div class="step-num">1</div>
        <h2>Connect your AI</h2>
        <span class="subtitle">Choose provider & paste your API key</span>
      </div>
      <div class="card-body">
        <div class="field-row">
          <div class="field">
            <label>AI Provider</label>
            <select id="provider" onchange="onProviderChange()">
              <option value="gemini">Google Gemini</option>
              <option value="perplexity">Perplexity AI</option>
              <option value="openai">OpenAI (ChatGPT)</option>
              <option value="groq">Groq (Fast &amp; Free)</option>
              <option value="mistral">Mistral AI</option>
              <option value="openrouter">OpenRouter (200+ models)</option>
              <option value="custom">Custom / Local AI</option>
            </select>
          </div>
          <div class="field">
            <label>Model</label>
            <div class="model-row">
              <select id="model"></select>
              <button class="fetch-btn" onclick="fetchModels()" title="Load models available with your key">âŸ³ Load</button>
            </div>
          </div>
        </div>

        <div class="field" id="custom-url-field" style="display:none">
          <label>API Base URL</label>
          <input type="text" id="custom-url" placeholder="e.g. http://localhost:11434/v1 for Ollama" />
        </div>

        <div class="field">
          <label>API Key</label>
          <div class="key-row">
            <input type="password" id="api-key" placeholder="Paste your API key here" autocomplete="off" />
            <div class="key-actions">
              <button class="icon-btn" onclick="toggleKey()" title="Show/hide">ğŸ‘</button>
              <button class="icon-btn" onclick="clearKey()" title="Clear">âœ•</button>
            </div>
          </div>
          <p class="hint" id="key-hint"></p>
        </div>

        <label class="checkbox-row">
          <input type="checkbox" id="save-key" onchange="onSaveKey()" />
          Remember my key in this browser (stored locally, never sent anywhere except the AI provider)
        </label>

        <div class="provider-note" id="provider-note"></div>
        <p class="hint" id="model-hint"></p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="step-num">2</div>
        <h2 id="input-card-title">Enter your input</h2>
        <span class="subtitle" id="input-card-subtitle">What would you like to analyse?</span>
      </div>
      <div class="card-body">
        <div class="field">
          <label id="input-label">Your input</label>
          <textarea id="user-input" rows="5" placeholder="Start typing here..."></textarea>
        </div>
      </div>
    </div>

    <div class="run-card">
      <p class="run-card-text" id="run-hint">Your prompt template runs automatically â€” just click Run.</p>
      <button class="run-btn" id="run-btn" onclick="runPrompt()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M3 2.5l10 5.5-10 5.5V2.5z"/></svg>
        Run Analysis
      </button>
    </div>

    <div class="error-box" id="error-box"></div>

    <div class="output-card" id="output-card">
      <div class="output-toolbar">
        <span class="label">Result</span>
        <span class="model-tag" id="output-model-tag">â€”</span>
        <button class="small-btn" onclick="copyOutput()">Copy</button>
        <button class="small-btn" onclick="clearOutput()">Clear</button>
      </div>
      <div class="output-body">
        <div class="skeleton" id="skeleton">
          <div class="skel-line h"></div>
          <div class="skel-line"></div>
          <div class="skel-line"></div>
          <div class="skel-line"></div>
          <div class="skel-line h"></div>
          <div class="skel-line"></div>
          <div class="skel-line"></div>
        </div>
        <div id="output-content"></div>
      </div>
    </div>

  </div></main>

<footer>
  ğŸ”’ Your API key is <span>never stored on any server</span> â€” it goes directly from your browser to the AI provider.
  <span class="sep">|</span>
  Powered by AI APIs
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âœï¸  OWNER CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {

  // â”€â”€ Branding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  appTitle:      'Supply Chain & Procurement Deep Scan',
  appBadge:      'Validation Task Force',
  pageTitle:     'Tier 1 <span>Validation Scan</span>',
  pageSubtitle:  'Enter a company name below to perform a deterministic market intelligence deep scan.',

  // â”€â”€ Input box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  inputCardTitle:    'Target Company',
  inputCardSubtitle: 'Which Tier 1 company are we validating?',
  inputLabel:        'Company Name',
  inputPlaceholder:  'e.g. Siemens, Maersk, Foxconn...',

  // â”€â”€ Run button hint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  runHint: 'The Signal Strength Matrix and Counter-Evidence checks run automatically â€” just click Run.',

  // â”€â”€ The AI role (system prompt) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  systemPrompt: `You are a senior Supply Chain & Procurement strategy consultant performing structured market intelligence analysis.
CONTEXT: We are a boutique Supply Chain & Procurement consulting firm operating as a rapid-deployment task force.`,

  // â”€â”€ The prompt template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  promptTemplate: `TARGET COMPANY TO ANALYSE: {{input}}

TASK
A list of Tier 1 companies has already been identified through an initial scan. You must now perform a deeper, highly deterministic validation scan of the company provided above by strictly applying the definitions, signals, and source hierarchies provided below.

You will move away from generic summaries and evaluate the companies using a strict "Signal Strength Matrix" and a "Counter-Evidence Check," outputting the final analysis exclusively in a structured HTML table.

===============================================================================
MANDATORY SITUATION DEFINITIONS â€” USE THESE EXCLUSIVELY
===============================================================================
The four situations below are the ONLY valid situations to detect and score.
Do not infer, invent, or substitute alternative situation definitions. Apply these definitions exactly as written when evaluating each company.

SITUATION 1 â€” RESOURCE CONSTRAINTS

Definition: Company shows insufficient execution capacity (people/bandwidth) in Supply Chain and/or Procurement.
Capability gap: missing specialised expertise required to deliver initiatives (not just to design them).
Execution backlog persists despite clear priorities or announced programs. Evidence must show internal resourcing shortfall, not external demand/supply shocks.

What it is NOT (avoid false positives):
- Not a temporary peak workload caused only by seasonality
- Not general hiring for growth (normal scaling)
- Not project delays caused mainly by unclear governance, strategy uncertainty, or budget freeze
- Not a supply disruption (that is Situation 4)
- Not margin-driven layoffs (that is Situation 2)

Observable signals and weights:
Financial
STRONG (+2): External workforce / contractor reliance explicitly described as necessary to execute SC/Proc work
MEDIUM (+1): SG&A / Opex increase partly attributed to temporary operational delivery support
Operational
STRONG (+2): Key initiatives delayed explicitly due to lack of internal execution capacity (ERP / IBP / S&OP / logistics transformation)
MEDIUM (+1): Execution backlog / delayed deliverables described (resource cause implied but not explicit)
Organisational
STRONG (+2): Management explicitly states resource constraints / lack of bandwidth / capacity shortage
STRONG (+2): Urgent hiring for SC/Proc roles (urgent, immediate start, critical hire)
STRONG (+2): Repeated leadership churn in SC/Proc key roles (CPO / Planning Head / Logistics Director)
MEDIUM (+1): Persistent high volume of SC/Proc vacancies without urgency keywords
MEDIUM (+1): Reviews reporting chronic understaffing (supporting evidence only)
Ecosystem
STRONG (+2): Public partnership or program explicitly announced to accelerate execution using external support
MEDIUM (+1): Staffing partners / contractor ecosystem presence implied (frequent interim posts, staffing firm campaigns)

SITUATION 2 â€” MARGIN PRESSURE

Definition: Profitability declines or stays structurally weak due to cost inflation, inefficiency, or pricing pressure.
Company explicitly announces cost reduction / productivity / cash protection measures.
Margin deterioration is not explained solely by planned investment for growth. Typically evidenced through management statements and financial results.

What it is NOT (avoid false positives):
- Not a growth investment phase with strong profitability maintained
- Not a one-off exceptional event without continuation (unless reconfirmed)
- Not pure FX impact with otherwise stable margins
- Not disruption-driven service failure only (Situation 4)
- Not resource lack without financial stress (Situation 1)

Observable signals and weights:
Financial
STRONG (+2): Gross margin / EBITDA margin decline reported and discussed as structural (not one-off)
STRONG (+2): Guidance downgrade explicitly due to cost inflation / inefficiencies / pricing pressure
STRONG (+2): Quantified cost-out / savings program (value + timeframe)
MEDIUM (+1): Input costs / inflation described as headwind without quantified structural margin impact
MEDIUM (+1): Freight / energy / labor costs cited as major headwind
Operational
STRONG (+2): Restructuring actions tied to margin recovery (plant closure, footprint rationalisation, SKU reduction)
STRONG (+2): Procurement-driven savings program launched with targets (cost reduction / supplier renegotiation)
MEDIUM (+1): Broad efficiency / simplification / lean initiatives repeated without quantified targets
Organisational
STRONG (+2): Layoffs / hiring freeze explicitly justified by profitability pressure or cost control
MEDIUM (+1): Internal cost controls signaled (reduced discretionary spend; halted initiatives)
Ecosystem
STRONG (+2): Divestments / portfolio exits explicitly framed as margin repair
MEDIUM (+1): Supplier renegotiation narrative without quantified targets

SITUATION 3 â€” SIGNIFICANT GROWTH

Definition: Company shows rapid growth in revenue, production volumes, footprint or channels.
Growth creates operational scaling pressure (capacity, service levels, inventory, supplier capability).
Evidence shows expansion initiatives (plants/DCs, new markets, M&A integration, product launches). Growth outpaces operational maturity / systems.

What it is NOT (avoid false positives):
- Not stable or low growth with routine hiring
- Not pure share price growth without operational scaling evidence
- Not growth driven only by short-lived commodity pricing
- Not disruption-related volume spikes from shortages elsewhere (unless sustained)
- Not margin pressure disguised as a growth story

Observable signals and weights:
Financial
STRONG (+2): Sustained high growth explicitly linked to scaling capacity and execution limits
MEDIUM (+1): Capex intensity rising (trend) consistent with growth narrative (no explicit project)
Operational
STRONG (+2): Major capacity expansion announced (new plant / lines / DC / automation ramp)
STRONG (+2): M&A integration / carve-out execution program active
STRONG (+2): Service/backlog pressure explicitly due to demand growth
MEDIUM (+1): Portfolio complexity increasing (product launches / SKU growth)
MEDIUM (+1): Expansion of logistics network / 3PL capacity due to volume growth
Organisational
STRONG (+2): Explicit hiring ramp to scale SC execution (planners, buyers, manufacturing ops, logistics ops)
MEDIUM (+1): Multiple new SC/Proc roles created (growth connection not explicit)
Ecosystem
STRONG (+2): Entry into multiple new geographies/channels requiring operational redesign
MEDIUM (+1): New supplier onboarding / manufacturing partnerships due to growth

SITUATION 4 â€” SUPPLY CHAIN DISRUPTION

Definition: Company experiences severe, active disruption affecting service, supply continuity, capacity, or logistics.
Evidence includes shortages, delays, shutdowns, supplier failure, quality incidents, forced re-sourcing.
Disruption has material business impact: lost sales, missed guidance, customer penalties, inventory shock. Requires stabilisation actions beyond normal operations.

What it is NOT (avoid false positives):
- Not normal lead time variability
- Not margin pressure without supply failure
- Not internal capacity constraints unrelated to external disruptions
- Not planned shutdowns / routine maintenance
- Not generic risk statements without observable events

Observable signals and weights:
Financial
STRONG (+2): Missed sales / guidance explicitly attributed to supply disruption/shortage
STRONG (+2): Inventory shock explicitly linked to disruption (forced build, obsolescence, allocation)
MEDIUM (+1): Premium freight / expediting costs explicitly mentioned as response to disruption
Operational
STRONG (+2): Production shutdown due to material shortage / supplier failure
STRONG (+2): Recall / quality crisis causing supply interruption
STRONG (+2): Public shortage/backorder announcements impacting customers
MEDIUM (+1): Supply constraints repeatedly mentioned without quantified impact
Organisational
STRONG (+2): Company announces crisis stabilisation actions (re-sourcing, allocation controls, rapid dual sourcing, task force)
MEDIUM (+1): Hiring for disruption-response roles (expeditors, supplier quality, crisis planners)
Ecosystem
STRONG (+2): Force majeure / supplier insolvency materially affecting continuity
STRONG (+2): Major logistics disruption with material impact (strikes, port closures, route disruption)
MEDIUM (+1): Supplier concentration risk cited as immediate operational risk (only if reconfirmed recently)

===============================================================================
1. SCORING â€” SIGNAL STRENGTH MATRIX (Deterministic)
===============================================================================
Score each of the 4 situations independently using the signal weights defined above. Score every valid signal found.

Classification thresholds â€” apply per situation after summing all signal points:
CONFIRMED    =  10 or more points
LIKELY       =  6 to 9 points
UNCLEAR      =  3 to 5 points
NOT PRESENT  =  0 to 2 points

===============================================================================
2. THE COUNTER-EVIDENCE CHECK (Crucial)
===============================================================================
To avoid confirmation bias, actively search for mitigating factors: recent record margins, new permanent CPO hired, major SC hiring spree completed, or any other data suggesting the company does not have an execution gap.
Log findings even if they do not change the classification.

===============================================================================
3. CRITICAL ANTI-HALLUCINATION AND EVIDENCE RULES
===============================================================================
- Zero Prior Knowledge: use ONLY publicly available online evidence reviewed during this exact session
- No Hallucinated URLs: all URLs must be real, clickable, and point directly to the source. If you cannot find a real URL, you cannot use the evidence.
- Direct Quotes Mandatory: every piece of evidence MUST be backed by a short direct verbatim quote of 25 words or fewer from the source
- Date Check: prioritise evidence from the last 6 to 12 months. Reject undated articles.

===============================================================================
OUTPUT FORMAT: THE DEEP SCAN TABLE
===============================================================================
Present the deep scan for the company as ONE single unified HTML table.

CRITICAL RULES:
- DO NOT write any paragraphs, summaries, or markdown outside of this table.
- The output must strictly be standard HTML using <table>, <thead>, <tr>, <th>, <tbody>, and <td> tags.
- Use HTML <ul> and <li> tags inside cells for bulleted lists to ensure readability.
- Do not wrap the output in markdown code blocks.

The table must have exactly these 5 columns in this order:

Column 1 â€” Company Name
Column 2 â€” Situation Status (All 4)
Column 3 â€” Exact Signals Detected
Column 4 â€” Counter-Evidence / Risks
Column 5 â€” Verified Sources and Quotes
`,

  // â”€â”€ Output rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Switched back to HTML so the browser renders the visual table grid
  outputMode: 'html',

};
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Engine â€” no need to edit below this line
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PROVIDERS = {
  gemini: {
    name: 'Google Gemini',
    models: ['gemini-2.0-flash', 'gemini-2.0-flash-lite', 'gemini-1.5-flash', 'gemini-1.5-flash-8b', 'gemini-1.5-pro'],
    keyHint: 'Get a free key at <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> â€” no billing required.',
    note: { type: 'ok', msg: 'âœ“ Works directly from the browser. No proxy needed.' },
    type: 'gemini'
  },
  perplexity: {
    name: 'Perplexity AI',
    url: 'https://api.perplexity.ai/chat/completions',
    models: ['llama-3.1-sonar-large-128k-online', 'llama-3.1-sonar-small-128k-online', 'llama-3.1-sonar-huge-128k-online'],
    keyHint: 'Get your key at <a href="https://www.perplexity.ai/settings/api" target="_blank">perplexity.ai â†’ Settings â†’ API</a>.',
    note: { type: 'ok', msg: 'âœ“ Works directly from the browser.' },
    type: 'openai'
  },
  openai: {
    name: 'OpenAI',
    url: 'https://api.openai.com/v1/chat/completions',
    models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo'],
    keyHint: 'Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>.',
    note: null,
    type: 'openai'
  },
  groq: {
    name: 'Groq',
    url: 'https://api.groq.com/openai/v1/chat/completions',
    models: ['llama-3.3-70b-versatile', 'llama-3.1-8b-instant', 'mixtral-8x7b-32768', 'gemma2-9b-it'],
    keyHint: 'Free tier available at <a href="https://console.groq.com/keys" target="_blank">console.groq.com</a>. Very fast.',
    note: { type: 'ok', msg: 'âœ“ Free tier available. Extremely fast responses.' },
    type: 'openai'
  },
  mistral: {
    name: 'Mistral AI',
    url: 'https://api.mistral.ai/v1/chat/completions',
    models: ['mistral-large-latest', 'mistral-small-latest', 'open-mistral-7b'],
    keyHint: 'Get your key at <a href="https://console.mistral.ai/api-keys/" target="_blank">console.mistral.ai</a>.',
    note: null,
    type: 'openai'
  },
  openrouter: {
    name: 'OpenRouter',
    url: 'https://openrouter.ai/api/v1/chat/completions',
    models: ['anthropic/claude-3.5-sonnet', 'openai/gpt-4o', 'google/gemini-flash-1.5', 'meta-llama/llama-3.3-70b-instruct:free'],
    keyHint: 'One key for 200+ models at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai</a>. Includes free models.',
    note: { type: 'ok', msg: 'âœ“ Access almost any AI model with a single key.' },
    type: 'openai'
  },
  custom: {
    name: 'Custom',
    models: ['custom-model'],
    keyHint: 'Enter the base URL above. Supports Ollama, LM Studio, or any OpenAI-compatible local server.',
    note: { type: 'ok', msg: 'â„¹ Works with local models (Ollama, LM Studio) â€” no API key needed for local.' },
    type: 'openai'
  }
};

// â”€â”€ Apply CONFIG to the page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyConfig() {
  document.title                                   = CONFIG.appTitle;
  document.getElementById('header-title').textContent   = CONFIG.appTitle;
  document.getElementById('header-badge').textContent   = CONFIG.appBadge;
  document.getElementById('page-title').innerHTML        = CONFIG.pageTitle.replace(/AI-Powered/, '<span>AI-Powered</span>');
  document.getElementById('page-subtitle').textContent  = CONFIG.pageSubtitle;
  document.getElementById('input-card-title').textContent   = CONFIG.inputCardTitle;
  document.getElementById('input-card-subtitle').textContent = CONFIG.inputCardSubtitle;
  document.getElementById('input-label').textContent   = CONFIG.inputLabel;
  document.getElementById('user-input').placeholder     = CONFIG.inputPlaceholder;
  document.getElementById('run-hint').textContent       = CONFIG.runHint;
}

// â”€â”€ Provider UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onProviderChange() {
  const pid = document.getElementById('provider').value;
  const p   = PROVIDERS[pid];

  const sel = document.getElementById('model');
  sel.innerHTML = p.models.map(m => `<option value="${m}">${m}</option>`).join('');

  document.getElementById('key-hint').innerHTML = p.keyHint;

  const noteEl = document.getElementById('provider-note');
  noteEl.className = 'provider-note';
  if (p.note) { noteEl.classList.add(p.note.type); noteEl.textContent = p.note.msg; }

  document.getElementById('custom-url-field').style.display = pid === 'custom' ? 'flex' : 'none';
  document.getElementById('model-hint').textContent = '';

  // Restore saved key if available
  const saved = localStorage.getItem(`key_${pid}`);
  if (saved) {
    document.getElementById('api-key').value = saved;
    document.getElementById('save-key').checked = true;
  } else {
    const anyKey = document.getElementById('save-key').checked;
    if (!anyKey) document.getElementById('api-key').value = '';
    document.getElementById('save-key').checked = !!saved;
  }
}

function toggleKey() {
  const inp = document.getElementById('api-key');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

function clearKey() {
  const pid = document.getElementById('provider').value;
  document.getElementById('api-key').value = '';
  document.getElementById('api-key').type = 'password';
  localStorage.removeItem(`key_${pid}`);
  document.getElementById('save-key').checked = false;
}

function onSaveKey() {
  const pid  = document.getElementById('provider').value;
  const key  = document.getElementById('api-key').value.trim();
  const save = document.getElementById('save-key').checked;
  if (save && key) localStorage.setItem(`key_${pid}`, key);
  else localStorage.removeItem(`key_${pid}`);
}

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state, msg) {
  document.getElementById('status-dot').className  = 'dot ' + state;
  document.getElementById('status-text').textContent = msg;
}

// â”€â”€ Fetch available models â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchModels() {
  const pid  = document.getElementById('provider').value;
  const key  = document.getElementById('api-key').value.trim();
  const hint = document.getElementById('model-hint');
  if (!key && pid !== 'custom') { hint.innerHTML = '<span style="color:var(--red)">Enter your API key first.</span>'; return; }

  hint.innerHTML = 'Loading modelsâ€¦';
  try {
    let models = [];
    if (pid === 'gemini') {
      const res  = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      models = (data.models || []).filter(m => m.supportedGenerationMethods?.includes('generateContent')).map(m => m.name.replace('models/', ''));
    } else if (pid === 'openrouter') {
      const res  = await fetch('https://openrouter.ai/api/v1/models', { headers: { Authorization: `Bearer ${key}` } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      models = (data.data || []).map(m => m.id);
    } else {
      const p    = PROVIDERS[pid];
      let base   = p.url ? p.url.replace('/chat/completions', '') : '';
      if (pid === 'custom') base = document.getElementById('custom-url').value.trim().replace(/\/$/, '');
      const res  = await fetch(`${base}/models`, { headers: { Authorization: `Bearer ${key}` } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      models = (data.data || []).map(m => m.id).sort();
    }
    if (!models.length) throw new Error('No models returned');
    document.getElementById('model').innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
    hint.innerHTML = `<span style="color:var(--green)">âœ“ ${models.length} models loaded from your account.</span>`;
  } catch (e) {
    hint.innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
  }
}

// â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callOpenAI(url, key, model, messages, temp, maxTok) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` },
    body: JSON.stringify({ model, messages, temperature: temp, max_tokens: maxTok })
  });
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || `HTTP ${res.status}`); }
  const data = await res.json();
  return data.choices[0].message.content;
}

async function callGemini(key, model, messages, temp, maxTok) {
  const contents = [];
  let sys = '';
  for (const m of messages) {
    if (m.role === 'system') { sys = m.content; continue; }
    contents.push({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] });
  }
  const body = { contents, generationConfig: { temperature: temp, maxOutputTokens: maxTok } };
  if (sys) body.systemInstruction = { parts: [{ text: sys }] };
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
  });
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || `HTTP ${res.status}`); }
  const data = await res.json();
  return data.candidates[0].content.parts[0].text;
}

// â”€â”€ Markdown â†’ HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mdToHtml(md) {
  return md
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm,  '<h2>$1</h2>')
    .replace(/^# (.+)$/gm,   '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/^[-*] (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>[\s\S]*?<\/li>\n?)+/g, s => `<ul>${s}</ul>`)
    .replace(/^---$/gm, '<hr>')
    .split('\n\n').map(b => b.startsWith('<') ? b : `<p>${b}</p>`).join('');
}

// â”€â”€ Main run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runPrompt() {
  const pid       = document.getElementById('provider').value;
  const key       = document.getElementById('api-key').value.trim();
  const model     = document.getElementById('model').value;
  const userInput = document.getElementById('user-input').value.trim();

  if (!key && pid !== 'custom') { showError('Please enter your API key in Step 1.'); return; }
  if (!userInput)                { showError('Please enter some text in Step 2 before running.'); return; }

  // Save key if checkbox checked
  if (document.getElementById('save-key').checked && key) {
    localStorage.setItem(`key_${pid}`, key);
  }

  const finalPrompt = CONFIG.promptTemplate.replace(/\{\{input\}\}/g, userInput);
  const messages = [];
  if (CONFIG.systemPrompt) messages.push({ role: 'system', content: CONFIG.systemPrompt });
  messages.push({ role: 'user', content: finalPrompt });

  // UI: loading state
  document.getElementById('run-btn').disabled = true;
  document.getElementById('error-box').classList.remove('visible');
  document.getElementById('output-card').classList.add('visible');
  document.getElementById('skeleton').classList.add('visible');
  document.getElementById('output-content').innerHTML = '';
  document.getElementById('output-model-tag').textContent = `${PROVIDERS[pid].name} / ${model}`;
  setStatus('busy', 'Thinkingâ€¦');

  try {
    let result;
    const p = PROVIDERS[pid];
    if (p.type === 'gemini') {
      result = await callGemini(key, model, messages, 0.7, 2048);
    } else {
      let url = p.url;
      if (pid === 'custom') url = document.getElementById('custom-url').value.trim().replace(/\/$/, '') + '/chat/completions';
      result = await callOpenAI(url, key, model, messages, 0.7, 2048);
    }

    document.getElementById('skeleton').classList.remove('visible');

    const out = document.getElementById('output-content');
    if (CONFIG.outputMode === 'raw') {
      out.textContent = result;
    } else if (CONFIG.outputMode === 'markdown') {
      out.innerHTML = mdToHtml(result);
    } else {
      // Strip code fences if the AI wrapped the HTML
      const match = result.match(/```html\n?([\s\S]*?)```/) || result.match(/```\n?([\s\S]*?)```/);
      out.innerHTML = match ? match[1] : result;
    }

    setStatus('ready', 'Done');
  } catch (err) {
    document.getElementById('skeleton').classList.remove('visible');
    showError(`Error: ${err.message}`);
    setStatus('error', 'Error');
  } finally {
    document.getElementById('run-btn').disabled = false;
  }
}

function showError(msg) {
  const el = document.getElementById('error-box');
  el.textContent = msg;
  el.classList.add('visible');
}

function copyOutput() {
  const text = document.getElementById('output-content').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function clearOutput() {
  document.getElementById('output-card').classList.remove('visible');
  document.getElementById('output-content').innerHTML = '';
  document.getElementById('skeleton').classList.remove('visible');
  setStatus('ready', 'Ready');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
applyConfig();
onProviderChange();
setStatus('ready', 'Ready');
if (window.location.protocol === 'file:') {
  document.getElementById('file-warn').style.display = 'block';
}
</script>
</body>
</html>
